---
draft: true
spelling: cSpell:ignore addressbook Chalin Huang pcapng Qiangxiong subdissectors tcpdump Wireshark
title: Analyzing gRPC messages using Wireshark
date: 2021-01-18
authors:
- name: Huang Qiangxiong
  link: https://github.com/huangqiangxiong
- name: Patrice Chalin (editor)
  link: https://github.com/chalin
---

[Wireshark](https://www.wireshark.org) is an open source network protocol
analyzer that can be used for protocol development, network troubleshooting, and
education. Wireshark lets you analyze gRPC messages that are transferred over
the network, and learn about the binary format of these messages.

In this post, you'll learn how to configure and use the Wireshark [gRPC
dissector][] and the [Protocol Buffers (Protobuf) dissector][pbd], which are
protocol-specific components that allow you to analyze gRPC messages with
Wireshark.

## Features

The main features of the gRPC and Protobuf dissectors are the following:

- Support dissecting (decoding) gRPC messages serialized in the
  [protocol buffer wire format][] or as JSON

- Support dissecting gRPC messages of unary, server streaming, client streaming,
  and bidirectional streaming RPC calls

- Enhanced dissection of serialized protocol buffers data by allowing
  you to do the following:
  - Load relevant `.proto` files
  - Register your own subdissectors for protocol buffer fields of type `byte` or
    `string`

## Capturing gRPC traffic

This post focuses on the analysis of captured gRPC messages. To learn how to
store network traffic in _capture files_, see [Capturing Live Network Data][]
from the [Wireshark User’s Guide][].

{{< alert title="Note" color="info" >}}
  Currently, Wireshark can only parse **plain text** gRPC messages. While
  [Wireshark supports TLS dissection][], it requires per-session secret keys. As
  of the time of writing, gRPC libraries do not support the exporting of such
  keys.

  [Wireshark supports TLS dissection]: https://gitlab.com/wireshark/wireshark/-/wikis/tls
{{</alert>}}

## Example

Let's walk through the setup necessary to analyze previously-captured messages
that were generated by a slightly extended version of the _address book_ app
used in the [Protocol Buffers tutorials][].

### Address book `.proto` files

The app's main protocol file is `addressbook.proto`:

```protobuf
syntax = "proto3";
package tutorial;
import "google/protobuf/timestamp.proto";

message Person {
  string name = 1;
  int32 id = 2;  // Unique ID number for this person.
  string email = 3;

  enum PhoneType {
    MOBILE = 0;
    HOME = 1;
    WORK = 2;
  }

  message PhoneNumber {
    string number = 1;
    PhoneType type = 2;
  }

  repeated PhoneNumber phone = 4;
  google.protobuf.Timestamp last_updated = 5;
  bytes portrait_image = 6;
}

message AddressBook {
  repeated Person people = 1;
}
```

This file is identical to the [Protocol Buffers tutorial version][pb-ab.proto],
except for the additional `portrait_image` field.

Note the `import` statement at the top of the file, it is used to import
`Timestamp`, which is one of many [Protocol Buffers Well-Known Types][].

Our variant of the app also defines a _person-search_ service that can be used
to search for address book entries based on selected `Person` attributes. The
service is defined in `person_search_service.proto`:

```protobuf
syntax = "proto3";
package tutorial;
import "addressbook.proto";

message PersonSearchRequest {
  repeated string name = 1;
  repeated int32 id = 2;
  repeated string phoneNumber = 3;
}

service PersonSearchService {
  rpc Search (PersonSearchRequest) returns (stream Person) {}
}
```

Because the service uses the `Person` type defined in `addressbook.proto`,
the address book `.proto` is imported at the start of the file.

### Setting protobuf search paths

Wireshark gives the most meaningful decodings when it knows about the `.proto`
files used by the apps whose messages you are analyzing.

You can tell Wireshark where to find `.proto` files by setting the **Protobuf
Search Paths** in the preferences accessible from the **Edit** menu under
**Preferences \> Protocols \> Protobuf**.

If our example app's `.proto` files are in the `d:/protos/my_proto_files` directory,
and the official Protobuf library directory is
`d:/protos/protobuf-3.4.1/include`, then add these two paths as _source
directories_ like this:

<!--
TODO: Remove the "For searching", or at least change it to "Paths to", which would be more grammatically correct.
TODO: Is the path "C:\Users\...protobuf_search_paths" actually part of the dialog? If not, can you remove it?
-->
![wireshark_protobuf_search_paths](/img/wireshark_protobuf_search_paths.png)

By selecting the **Load all files** option for the app's protocol directory you
enable preloading of message definitions from the `addressbook.proto` file.

### Setting port traffic type

From the Wireshark [SampleCaptures page][], download the following app's sample gRPC capture file:
[grpc_person_search_protobuf_with_image.pcapng][].

<!--
TODO: Why port 50052? I'm not seeing any traffic over port 50052 in the
      screenshots. Is it actually used?
-->
The app's gRPC traffic was captured on ports 50051 and 50052. Before you can
decode these messages, first register these ports as carrying HTTP2 traffic:

<!--
TODO: Clarify: how does the user access this configuration pane?
TODO: Is the port 18127 relevant to this blog post, if not, can you remove it?
TODO: Is the path "C:\Users\...decode_as_entries" actually part of the dialog? If not, can you remove it?
-->
![wireshark_decode_as_dialog](/img/wireshark_decode_as_dialog.png)

### Decoding the search request message

<!--
TODO: What are the steps that the user needs to follow before the user can see
      the decoded message as shown in the screenshot?
-->
Here's a screenshot of the sample's service request message:

<!--
TODO: Can you remove the commentary text (in blue) from the image. Such text is
      best placed in the body of the post (it makes it easier to edit, and
      eventually possibly translate into other languages :))

TODO: If a users opens up the "GRPC_Message" section in that display, what will
      be shown?
-->
![wireshark_grpc_protobuf_search_request](/img/wireshark_grpc_protobuf_search_request.png)

By examining the HTTP2 message header `path` field, you'll notice the URL to the
app's service (`/tutorial.PersonSearchService`), followed by the name of the
invoked RPC (`Search`).

The `content-type`, which is set by the gRPC library, informs Wireshark that the
HTTP2 message content is a gRPC message. By examining the decoded Protocol
Buffers message of the sample gRPC request, you can see that the search request
is for the names "Jason" and "Lily".

### Decoding the server-streamed response

Since the `Search` operation is defined as the server streaming RPC mode, the
Person objects can be return back to client one after another:

<!--

TODO: The response is sent over port 51035. Does a user need to configure the
      "decoding as" HTTP2 for this port?

      It might also be worth mentioning to the reader how we know that 51035 is the response port.
-->
![wireshark_grpc_protobuf_search_response](/img/wireshark_grpc_protobuf_search_response.png)

You may have noticed that the `portrait_image` of bytes type is parsed as a
PNG data.
<!--
TODO: Question: does the user actually see the image? If so, that isn't obvious from the screenshot.

FIXME: Regarding the start of the sentence above: "You may have noticed that
       ..." The user can't notice the decoding of the image because we haven't
       guided them in setting up the PNG dissector prior to this point.

Suggestion: Actually, I suggest that we drop the details concerning the
       setup of the image dissector, and simply refer any interested reader to
       https://gitlab.com/wireshark/wireshark/-/wikis/Protobuf#protobuf-field-subdissectors.
       We can simply mention that subdissectors, like the PNG dissector can be
       registered. Let me know what you think.
-->
It's because we register the PNG dissector in the `"protobuf_field"`
dissector table for parsing the value of field `portrait_image` as picture by
putting following Lua script `'protobuf_portrait_field.lua'` into the 'plugins'
subdirectory of 'Personal configuration' directory:

```lua
do
    local protobuf_field_table = DissectorTable.get("protobuf_field")
    local png_dissector = Dissector.get("png")
    protobuf_field_table:add("tutorial.Person.portrait_image", png_dissector)
end
```

## History of gRPC and Protocol Buffers support

Here is a brief annotated list of Wireshark versions as they relate to the
support of gRPC and Protocol Buffers:

- v2.6.0: first release of gRPC and Protobuf dissectors, without
  support for `.proto` files or streaming RPCs.
- v3.2.0: improved dissection of serialized protocol buffers data based on
  `.proto` files, and support of streaming RPCs.
- v3.3.0: improved and enhanced `.proto` file support, such as capture-file
  search on protocol buffer field values.
- v3.4.0: Protocol Buffers [Timestamp][] time is displayed as locale date-time
  string.

## Learn more

Interested in learning more? Start with the [Wireshark User’s Guide][]. For more
details concerning the example used in this post, as well as other sample
capture files of gRPC messages, see the [gRPC dissector][] and [Protocol Buffers
dissector][pbd] wiki pages.


[Capturing Live Network Data]: https://www.wireshark.org/docs/wsug_html_chunked/ChapterCapture.html
[gRPC dissector]: https://gitlab.com/wireshark/wireshark/-/wikis/gRPC
[grpc_person_search_protobuf_with_image.pcapng]: https://gitlab.com/wireshark/wireshark/-/wikis/uploads/f6fcdceb0248669c0b057bd15d45ab6f/grpc_person_search_protobuf_with_image.pcapng
[pb-ab.proto]: https://github.com/protocolbuffers/protobuf/blob/master/examples/addressbook.proto
[protocol buffer wire format]: https://developers.google.com/protocol-buffers/docs/encoding
[pbd]: https://gitlab.com/wireshark/wireshark/-/wikis/Protobuf
[Protocol Buffers tutorials]: https://developers.google.com/protocol-buffers/docs/tutorials
[Protocol Buffers Well-Known Types]: https://developers.google.com/protocol-buffers/docs/reference/google.protobuf
[SampleCaptures page]: https://gitlab.com/wireshark/wireshark/-/wikis/SampleCaptures
[Timestamp]: https://developers.google.com/protocol-buffers/docs/reference/google.protobuf#google.protobuf.Timestamp
[Wireshark User’s Guide]: https://www.wireshark.org/docs/wsug_html_chunked/
